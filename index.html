<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯å‚…è€å¸«çš„æœŸæœ«é€²åº¦è¡¨</title>
    <style>
        /* æ¨£å¼ä¿æŒä¸è®Šï¼Œç‚ºäº†ç‰ˆé¢æ•´æ½”æˆ‘çœç•¥é‡è¤‡çš„ CSSï¼Œç›´æ¥æ²¿ç”¨ä¸Šä¸€ç‰ˆçš„å³å¯ */
        :root { --primary: #4a90e2; --success: #2ecc71; --bg: #f5f7fa; --card-bg: #ffffff; --text: #2c3e50; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; }
        h1 { text-align: center; color: var(--text); margin-bottom: 30px; }
        .status-indicator { text-align: center; font-size: 0.8rem; margin-bottom: 20px; color: #888; }
        .status-indicator.connected { color: var(--success); }
        
        .input-group { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        #newItemName { flex: 2; min-width: 120px; }
        #newItemQty { flex: 1; min-width: 60px; }
        button.add-btn { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        button.add-btn:hover { background-color: #357abd; }
        
        .task-list { display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s; position: relative; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .task-name { font-size: 1.1rem; font-weight: bold; }
        .task-stats { font-size: 0.9rem; color: #666; }
        
        .progress-container { height: 20px; background-color: #e0e0e0; border-radius: 10px; overflow: hidden; margin-bottom: 15px; position: relative; }
        .progress-bar { height: 100%; background-color: var(--primary); width: 0%; transition: width 0.3s ease, background-color 0.3s ease; display: flex; align-items: center; justify-content: flex-end; }
        .progress-bar.completed { background-color: var(--success); }
        .progress-text { position: absolute; width: 100%; text-align: center; font-size: 12px; line-height: 20px; color: #333; font-weight: bold; }
        
        .controls { display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .btn-circle { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; background-color: #f0f0f0; color: #333; transition: all 0.2s; }
        .btn-circle:hover { background-color: #e0e0e0; transform: scale(1.1); }
        .btn-minus { color: #e74c3c; }
        .btn-plus { color: #2ecc71; background-color: #e8f8f5; }
        .btn-delete { background: none; border: none; color: #999; cursor: pointer; font-size: 14px; text-decoration: underline; margin-right: auto; }
        .btn-delete:hover { color: #e74c3c; }
        
        .reset-section { margin-top: 40px; text-align: center; }
        .btn-reset { background: none; border: 1px solid #ccc; padding: 5px 15px; color: #888; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        
        /* Loading é®ç½© */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; justify-content:center; align-items:center; z-index:9999; }
    </style>
</head>
<body>

<div id="loader">è³‡æ–™åŒæ­¥ä¸­...</div>

<div class="container">
    <h1>ğŸ¯å‚…è€å¸«çš„æœŸæœ«é€²åº¦è¡¨</h1>
    <div id="status" class="status-indicator">æ­£åœ¨é€£æ¥è³‡æ–™åº«...</div>

    <div class="input-group">
        <input type="text" id="newItemName" placeholder="è¼¸å…¥é …ç›®åç¨±">
        <input type="number" id="newItemQty" placeholder="æ•¸é‡" min="1">
        <button class="add-btn" onclick="addItem()">æ–°å¢</button>
    </div>

    <div id="taskList" class="task-list"></div>

    <div class="reset-section">
        <button class="btn-reset" onclick="resetData()">âš ï¸ é‡ç½®å›é è¨­å€¼ (æ‰€æœ‰äººçš„ç•«é¢éƒ½æœƒé‡ç½®)</button>
    </div>
</div>

<script type="module">
    // 1. å¼•å…¥ Firebase å¿…è¦æ¨¡çµ„
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // =========================================================
    // ğŸ”´ è«‹å°‡ä¸‹æ–¹æ›¿æ›ç‚ºæ‚¨å¾ Firebase Console è¤‡è£½çš„ Config
    // =========================================================
    	const firebaseConfig = {
  	apiKey: "AIzaSyCW6AD52wojUY3we5StqtOILEnIgvY49cM",
  	authDomain: "mrs-fu-gogo.firebaseapp.com",
  	databaseURL: "https://mrs-fu-gogo-default-rtdb.firebaseio.com",
  	projectId: "mrs-fu-gogo",
  	storageBucket: "mrs-fu-gogo.firebasestorage.app",
  	messagingSenderId: "1061778595200",
 	appId: "1:1061778595200:web:f5ef717262242009277565",
  	measurementId: "G-3PTSJ28W06"
	};
    // =========================================================

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tasksRef = ref(db, 'grades_v1'); // è³‡æ–™åº«è·¯å¾‘

    let tasks = [];
    
    // é è¨­è³‡æ–™
    const defaultData = [
        { id: 1, name: 'ç¸½è©•èª', total: 20, current: 0 },
        { id: 2, name: 'è¼”å°ç´€éŒ„', total: 20, current: 0 },
        { id: 3, name: 'å¹³æ™‚æˆç¸¾', total: 20, current: 0 },
        { id: 4, name: 'æ®µè€ƒæˆç¸¾', total: 20, current: 0 },
        { id: 5, name: 'ä½œæ–‡', total: 20, current: 0 }
    ];

    const listElement = document.getElementById('taskList');
    const statusElement = document.getElementById('status');
    const loader = document.getElementById('loader');

    // 2. ç›£è½è³‡æ–™åº«è®ŠåŒ– (é€™æ˜¯å³æ™‚åŒæ­¥çš„æ ¸å¿ƒ)
    onValue(tasksRef, (snapshot) => {
        const data = snapshot.val();
        
        statusElement.innerText = "ğŸŸ¢ å·²é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«";
        statusElement.classList.add('connected');
        loader.style.display = 'none';

        if (data) {
            // è³‡æ–™åº«æœ‰è³‡æ–™ï¼Œè½‰æˆé™£åˆ— (å› ç‚º Firebase å„²å­˜é™£åˆ—æœ‰æ™‚æœƒè®Šæˆ Object)
            tasks = Array.isArray(data) ? data : Object.values(data);
        } else {
            // è³‡æ–™åº«æ˜¯ç©ºçš„ (ç¬¬ä¸€æ¬¡ä½¿ç”¨)ï¼Œå¯«å…¥é è¨­å€¼
            tasks = defaultData;
            set(tasksRef, defaultData);
        }
        render(); // é‡æ–°æ¸²æŸ“ç•«é¢
    }, (error) => {
        statusElement.innerText = "ğŸ”´ é€£ç·šå¤±æ•—ï¼š" + error.message;
        loader.style.display = 'none';
    });

    // 3. æ¸²æŸ“ç•«é¢ (è·Ÿä¹‹å‰ä¸€æ¨£)
    function render() {
        listElement.innerHTML = '';
        
        // ç¢ºä¿ tasks æ˜¯é™£åˆ—ä¸”éæ¿¾æ‰ç©ºå€¼ (Firebase åˆªé™¤é™£åˆ—ä¸­é–“å…ƒç´ æ™‚æœƒç•™ null)
        const validTasks = tasks.filter(t => t); 
        
        validTasks.forEach((task, index) => {
            // æ³¨æ„ï¼šé€™è£¡çš„ index æ˜¯é¡¯ç¤ºç”¨çš„ï¼Œæ›´æ–°è³‡æ–™åº«è¦ç”¨åŸå§‹ ID æˆ–æ˜¯æ•´å€‹é‡å¯«
            // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘é€™è£¡æ“ä½œæ•´å€‹é™£åˆ—å†å›å¯«
            
            const percent = Math.min(100, Math.round((task.current / task.total) * 100));
            const isCompleted = percent === 100;
            
            const html = `
                <div class="card">
                    <div class="card-header">
                        <span class="task-name">${task.name} ${isCompleted ? 'âœ…' : ''}</span>
                        <span class="task-stats">${task.current} / ${task.total} (${percent}%)</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar ${isCompleted ? 'completed' : ''}" style="width: ${percent}%"></div>
                        <div class="progress-text">${percent}%</div>
                    </div>
                    <div class="controls">
                        <button class="btn-delete" id="del-${index}">åˆªé™¤</button>
                        <button class="btn-circle btn-minus" id="minus-${index}">-</button>
                        <button class="btn-circle btn-plus" id="plus-${index}">+</button>
                    </div>
                </div>
            `;
            const div = document.createElement('div');
            div.innerHTML = html;
            listElement.appendChild(div);

            // ç¶å®šäº‹ä»¶ (å› ç‚ºç”¨ module type scriptï¼Œä¸èƒ½ç›´æ¥ç”¨ onclick)
            div.querySelector(`#plus-${index}`).onclick = () => updateProgress(index, 1);
            div.querySelector(`#minus-${index}`).onclick = () => updateProgress(index, -1);
            div.querySelector(`#del-${index}`).onclick = () => deleteItem(index);
        });
    }

    // 4. æ›´æ–°é€²åº¦ -> å¯«å…¥è³‡æ–™åº«
    window.updateProgress = function(index, change) {
        // é‡æ–°è®€å–ç•¶å‰ç‹€æ…‹ï¼Œé¿å…èˆŠè³‡æ–™è¦†è“‹ (é›–ç„¶ onValue æœƒä¿æŒæ›´æ–°ï¼Œä½†å®‰å…¨èµ·è¦‹)
        const validTasks = tasks.filter(t => t);
        const task = validTasks[index];
        let newValue = task.current + change;
        
        if (newValue < 0) newValue = 0;
        if (newValue > task.total) newValue = task.total;

        task.current = newValue;
        
        // å°‡æ›´æ–°å¾Œçš„æ•´å€‹é™£åˆ—å¯«å› Firebase
        set(tasksRef, validTasks);
    }

    // 5. æ–°å¢é …ç›® -> å¯«å…¥è³‡æ–™åº«
    window.addItem = function() {
        const nameInput = document.getElementById('newItemName');
        const qtyInput = document.getElementById('newItemQty');
        const name = nameInput.value.trim();
        const qty = parseInt(qtyInput.value);

        if (!name || isNaN(qty) || qty <= 0) return alert('è¼¸å…¥æœ‰èª¤');

        const validTasks = tasks.filter(t => t);
        validTasks.push({ id: Date.now(), name: name, total: qty, current: 0 });
        
        set(tasksRef, validTasks); // åŒæ­¥åˆ°é›²ç«¯
        nameInput.value = '';
        qtyInput.value = '';
    }

    // 6. åˆªé™¤é …ç›®
    window.deleteItem = function(index) {
        if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
            const validTasks = tasks.filter(t => t);
            validTasks.splice(index, 1);
            set(tasksRef, validTasks); // åŒæ­¥åˆ°é›²ç«¯
        }
    }

    // 7. é‡ç½®
    window.resetData = function() {
        if(confirm('âš ï¸ è­¦å‘Šï¼šé€™æœƒæŠŠæ‰€æœ‰äººçš„ç•«é¢éƒ½é‡ç½®å›åˆå§‹ç‹€æ…‹ï¼')) {
            set(tasksRef, defaultData);
        }
    }
</script>

</body>

</html>
